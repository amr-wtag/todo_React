{"ast":null,"code":"/*\n  This file draws heavily from https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/assets/js/phoenix/presence.js\n  License: https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/LICENSE.md\n*/\nexport default class RealtimePresence {\n  /**\n   * Initializes the Presence.\n   *\n   * @param channel - The RealtimeSubscription\n   * @param opts - The options,\n   *        for example `{events: {state: 'state', diff: 'diff'}}`\n   */\n  constructor(channel, opts) {\n    this.channel = channel;\n    this.state = {};\n    this.pendingDiffs = [];\n    this.joinRef = null;\n    this.caller = {\n      onJoin: () => {},\n      onLeave: () => {},\n      onSync: () => {}\n    };\n    const events = (opts === null || opts === void 0 ? void 0 : opts.events) || {\n      state: 'presence_state',\n      diff: 'presence_diff'\n    };\n    this.channel.on(events.state, {}, newState => {\n      const {\n        onJoin,\n        onLeave,\n        onSync\n      } = this.caller;\n      this.joinRef = this.channel.joinRef();\n      this.state = RealtimePresence.syncState(this.state, newState, onJoin, onLeave);\n      this.pendingDiffs.forEach(diff => {\n        this.state = RealtimePresence.syncDiff(this.state, diff, onJoin, onLeave);\n      });\n      this.pendingDiffs = [];\n      onSync();\n    });\n    this.channel.on(events.diff, {}, diff => {\n      const {\n        onJoin,\n        onLeave,\n        onSync\n      } = this.caller;\n\n      if (this.inPendingSyncState()) {\n        this.pendingDiffs.push(diff);\n      } else {\n        this.state = RealtimePresence.syncDiff(this.state, diff, onJoin, onLeave);\n        onSync();\n      }\n    });\n  }\n  /**\n   * Used to sync the list of presences on the server with the\n   * client's state.\n   *\n   * An optional `onJoin` and `onLeave` callback can be provided to\n   * react to changes in the client's local presences across\n   * disconnects and reconnects with the server.\n   */\n\n\n  static syncState(currentState, newState, onJoin, onLeave) {\n    const state = this.cloneDeep(currentState);\n    const transformedState = this.transformState(newState);\n    const joins = {};\n    const leaves = {};\n    this.map(state, (key, presences) => {\n      if (!transformedState[key]) {\n        leaves[key] = presences;\n      }\n    });\n    this.map(transformedState, (key, newPresences) => {\n      const currentPresences = state[key];\n\n      if (currentPresences) {\n        const newPresenceIds = newPresences.map(m => m.presence_id);\n        const curPresenceIds = currentPresences.map(m => m.presence_id);\n        const joinedPresences = newPresences.filter(m => curPresenceIds.indexOf(m.presence_id) < 0);\n        const leftPresences = currentPresences.filter(m => newPresenceIds.indexOf(m.presence_id) < 0);\n\n        if (joinedPresences.length > 0) {\n          joins[key] = joinedPresences;\n        }\n\n        if (leftPresences.length > 0) {\n          leaves[key] = leftPresences;\n        }\n      } else {\n        joins[key] = newPresences;\n      }\n    });\n    return this.syncDiff(state, {\n      joins,\n      leaves\n    }, onJoin, onLeave);\n  }\n  /**\n   * Used to sync a diff of presence join and leave events from the\n   * server, as they happen.\n   *\n   * Like `syncState`, `syncDiff` accepts optional `onJoin` and\n   * `onLeave` callbacks to react to a user joining or leaving from a\n   * device.\n   */\n\n\n  static syncDiff(state, diff, onJoin, onLeave) {\n    const {\n      joins,\n      leaves\n    } = {\n      joins: this.transformState(diff.joins),\n      leaves: this.transformState(diff.leaves)\n    };\n\n    if (!onJoin) {\n      onJoin = () => {};\n    }\n\n    if (!onLeave) {\n      onLeave = () => {};\n    }\n\n    this.map(joins, (key, newPresences) => {\n      const currentPresences = state[key];\n      state[key] = this.cloneDeep(newPresences);\n\n      if (currentPresences) {\n        const joinedPresenceIds = state[key].map(m => m.presence_id);\n        const curPresences = currentPresences.filter(m => joinedPresenceIds.indexOf(m.presence_id) < 0);\n        state[key].unshift(...curPresences);\n      }\n\n      onJoin(key, currentPresences, newPresences);\n    });\n    this.map(leaves, (key, leftPresences) => {\n      let currentPresences = state[key];\n      if (!currentPresences) return;\n      const presenceIdsToRemove = leftPresences.map(m => m.presence_id);\n      currentPresences = currentPresences.filter(m => presenceIdsToRemove.indexOf(m.presence_id) < 0);\n      state[key] = currentPresences;\n      onLeave(key, currentPresences, leftPresences);\n      if (currentPresences.length === 0) delete state[key];\n    });\n    return state;\n  }\n  /**\n   * Returns the array of presences, with selected metadata.\n   */\n\n\n  static list(presences, chooser) {\n    if (!chooser) {\n      chooser = (_key, pres) => pres;\n    }\n\n    return this.map(presences, (key, presences) => chooser(key, presences));\n  }\n\n  static map(obj, func) {\n    return Object.getOwnPropertyNames(obj).map(key => func(key, obj[key]));\n  }\n  /**\n   * Remove 'metas' key\n   * Change 'phx_ref' to 'presence_id'\n   * Remove 'phx_ref' and 'phx_ref_prev'\n   *\n   * @example\n   * // returns {\n   *  abc123: [\n   *    { presence_id: '2', user_id: 1 },\n   *    { presence_id: '3', user_id: 2 }\n   *  ]\n   * }\n   * RealtimePresence.transformState({\n   *  abc123: {\n   *    metas: [\n   *      { phx_ref: '2', phx_ref_prev: '1' user_id: 1 },\n   *      { phx_ref: '3', user_id: 2 }\n   *    ]\n   *  }\n   * })\n   */\n\n\n  static transformState(state) {\n    state = this.cloneDeep(state);\n    return Object.getOwnPropertyNames(state).reduce((newState, key) => {\n      const presences = state[key];\n\n      if ('metas' in presences) {\n        newState[key] = presences.metas.map(presence => {\n          presence['presence_id'] = presence['phx_ref'];\n          delete presence['phx_ref'];\n          delete presence['phx_ref_prev'];\n          return presence;\n        });\n      } else {\n        newState[key] = presences;\n      }\n\n      return newState;\n    }, {});\n  }\n\n  static cloneDeep(obj) {\n    return JSON.parse(JSON.stringify(obj));\n  }\n\n  onJoin(callback) {\n    this.caller.onJoin = callback;\n  }\n\n  onLeave(callback) {\n    this.caller.onLeave = callback;\n  }\n\n  onSync(callback) {\n    this.caller.onSync = callback;\n  }\n\n  list(by) {\n    return RealtimePresence.list(this.state, by);\n  }\n\n  inPendingSyncState() {\n    return !this.joinRef || this.joinRef !== this.channel.joinRef();\n  }\n\n}","map":{"version":3,"mappings":"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","names":["RealtimePresence","constructor","channel","opts","onJoin","onLeave","onSync","events","state","diff","on","newState","caller","joinRef","syncState","pendingDiffs","forEach","syncDiff","inPendingSyncState","push","currentState","cloneDeep","transformedState","transformState","joins","leaves","map","key","presences","newPresences","currentPresences","newPresenceIds","m","presence_id","curPresenceIds","joinedPresences","filter","indexOf","leftPresences","length","joinedPresenceIds","curPresences","unshift","presenceIdsToRemove","list","chooser","_key","pres","obj","func","Object","getOwnPropertyNames","reduce","metas","presence","JSON","parse","stringify","callback","by"],"sources":["/Users/mridha/Todo_in_React/todo/node_modules/@supabase/realtime-js/src/RealtimePresence.ts"],"sourcesContent":["/*\n  This file draws heavily from https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/assets/js/phoenix/presence.js\n  License: https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/LICENSE.md\n*/\n\nimport {\n  PresenceOpts,\n  PresenceOnJoinCallback,\n  PresenceOnLeaveCallback,\n} from 'phoenix'\nimport RealtimeChannel from './RealtimeChannel'\n\ntype Presence = {\n  presence_id: string\n  [key: string]: any\n}\n\ntype PresenceState = { [key: string]: Presence[] }\n\ntype PresenceDiff = {\n  joins: PresenceState\n  leaves: PresenceState\n}\n\ntype RawPresenceState = {\n  [key: string]: Record<\n    'metas',\n    {\n      phx_ref?: string\n      phx_ref_prev?: string\n      [key: string]: any\n    }[]\n  >\n}\n\ntype RawPresenceDiff = {\n  joins: RawPresenceState\n  leaves: RawPresenceState\n}\n\ntype PresenceChooser<T> = (key: string, presences: any) => T\n\nexport default class RealtimePresence {\n  state: PresenceState = {}\n  pendingDiffs: RawPresenceDiff[] = []\n  joinRef: string | null = null\n  caller: {\n    onJoin: PresenceOnJoinCallback\n    onLeave: PresenceOnLeaveCallback\n    onSync: () => void\n  } = {\n    onJoin: () => {},\n    onLeave: () => {},\n    onSync: () => {},\n  }\n\n  /**\n   * Initializes the Presence.\n   *\n   * @param channel - The RealtimeSubscription\n   * @param opts - The options,\n   *        for example `{events: {state: 'state', diff: 'diff'}}`\n   */\n  constructor(public channel: RealtimeChannel, opts?: PresenceOpts) {\n    const events = opts?.events || {\n      state: 'presence_state',\n      diff: 'presence_diff',\n    }\n\n    this.channel.on(events.state, {}, (newState: RawPresenceState) => {\n      const { onJoin, onLeave, onSync } = this.caller\n\n      this.joinRef = this.channel.joinRef()\n\n      this.state = RealtimePresence.syncState(\n        this.state,\n        newState,\n        onJoin,\n        onLeave\n      )\n\n      this.pendingDiffs.forEach((diff) => {\n        this.state = RealtimePresence.syncDiff(\n          this.state,\n          diff,\n          onJoin,\n          onLeave\n        )\n      })\n\n      this.pendingDiffs = []\n\n      onSync()\n    })\n\n    this.channel.on(events.diff, {}, (diff: RawPresenceDiff) => {\n      const { onJoin, onLeave, onSync } = this.caller\n\n      if (this.inPendingSyncState()) {\n        this.pendingDiffs.push(diff)\n      } else {\n        this.state = RealtimePresence.syncDiff(\n          this.state,\n          diff,\n          onJoin,\n          onLeave\n        )\n\n        onSync()\n      }\n    })\n  }\n\n  /**\n   * Used to sync the list of presences on the server with the\n   * client's state.\n   *\n   * An optional `onJoin` and `onLeave` callback can be provided to\n   * react to changes in the client's local presences across\n   * disconnects and reconnects with the server.\n   */\n  static syncState(\n    currentState: PresenceState,\n    newState: RawPresenceState | PresenceState,\n    onJoin: PresenceOnJoinCallback,\n    onLeave: PresenceOnLeaveCallback\n  ): PresenceState {\n    const state = this.cloneDeep(currentState)\n    const transformedState = this.transformState(newState)\n    const joins: PresenceState = {}\n    const leaves: PresenceState = {}\n\n    this.map(state, (key: string, presences: Presence[]) => {\n      if (!transformedState[key]) {\n        leaves[key] = presences\n      }\n    })\n\n    this.map(transformedState, (key, newPresences: Presence[]) => {\n      const currentPresences: Presence[] = state[key]\n\n      if (currentPresences) {\n        const newPresenceIds = newPresences.map((m: Presence) => m.presence_id)\n        const curPresenceIds = currentPresences.map(\n          (m: Presence) => m.presence_id\n        )\n        const joinedPresences: Presence[] = newPresences.filter(\n          (m: Presence) => curPresenceIds.indexOf(m.presence_id) < 0\n        )\n        const leftPresences: Presence[] = currentPresences.filter(\n          (m: Presence) => newPresenceIds.indexOf(m.presence_id) < 0\n        )\n\n        if (joinedPresences.length > 0) {\n          joins[key] = joinedPresences\n        }\n\n        if (leftPresences.length > 0) {\n          leaves[key] = leftPresences\n        }\n      } else {\n        joins[key] = newPresences\n      }\n    })\n\n    return this.syncDiff(state, { joins, leaves }, onJoin, onLeave)\n  }\n\n  /**\n   * Used to sync a diff of presence join and leave events from the\n   * server, as they happen.\n   *\n   * Like `syncState`, `syncDiff` accepts optional `onJoin` and\n   * `onLeave` callbacks to react to a user joining or leaving from a\n   * device.\n   */\n  static syncDiff(\n    state: PresenceState,\n    diff: RawPresenceDiff | PresenceDiff,\n    onJoin: PresenceOnJoinCallback,\n    onLeave: PresenceOnLeaveCallback\n  ): PresenceState {\n    const { joins, leaves } = {\n      joins: this.transformState(diff.joins),\n      leaves: this.transformState(diff.leaves),\n    }\n\n    if (!onJoin) {\n      onJoin = () => {}\n    }\n\n    if (!onLeave) {\n      onLeave = () => {}\n    }\n\n    this.map(joins, (key, newPresences: Presence[]) => {\n      const currentPresences: Presence[] = state[key]\n      state[key] = this.cloneDeep(newPresences)\n\n      if (currentPresences) {\n        const joinedPresenceIds = state[key].map((m: Presence) => m.presence_id)\n        const curPresences: Presence[] = currentPresences.filter(\n          (m: Presence) => joinedPresenceIds.indexOf(m.presence_id) < 0\n        )\n\n        state[key].unshift(...curPresences)\n      }\n\n      onJoin(key, currentPresences, newPresences)\n    })\n\n    this.map(leaves, (key, leftPresences: Presence[]) => {\n      let currentPresences: Presence[] = state[key]\n\n      if (!currentPresences) return\n\n      const presenceIdsToRemove = leftPresences.map(\n        (m: Presence) => m.presence_id\n      )\n      currentPresences = currentPresences.filter(\n        (m: Presence) => presenceIdsToRemove.indexOf(m.presence_id) < 0\n      )\n\n      state[key] = currentPresences\n\n      onLeave(key, currentPresences, leftPresences)\n\n      if (currentPresences.length === 0) delete state[key]\n    })\n\n    return state\n  }\n\n  /**\n   * Returns the array of presences, with selected metadata.\n   */\n  static list<T = any>(\n    presences: PresenceState,\n    chooser: PresenceChooser<T> | undefined\n  ): T[] {\n    if (!chooser) {\n      chooser = (_key, pres) => pres\n    }\n\n    return this.map(presences, (key, presences: Presence[]) =>\n      chooser!(key, presences)\n    )\n  }\n\n  private static map<T = any>(\n    obj: PresenceState,\n    func: PresenceChooser<T>\n  ): T[] {\n    return Object.getOwnPropertyNames(obj).map((key) => func(key, obj[key]))\n  }\n\n  /**\n   * Remove 'metas' key\n   * Change 'phx_ref' to 'presence_id'\n   * Remove 'phx_ref' and 'phx_ref_prev'\n   *\n   * @example\n   * // returns {\n   *  abc123: [\n   *    { presence_id: '2', user_id: 1 },\n   *    { presence_id: '3', user_id: 2 }\n   *  ]\n   * }\n   * RealtimePresence.transformState({\n   *  abc123: {\n   *    metas: [\n   *      { phx_ref: '2', phx_ref_prev: '1' user_id: 1 },\n   *      { phx_ref: '3', user_id: 2 }\n   *    ]\n   *  }\n   * })\n   */\n  private static transformState(\n    state: RawPresenceState | PresenceState\n  ): PresenceState {\n    state = this.cloneDeep(state)\n\n    return Object.getOwnPropertyNames(state).reduce((newState, key) => {\n      const presences = state[key]\n\n      if ('metas' in presences) {\n        newState[key] = presences.metas.map((presence) => {\n          presence['presence_id'] = presence['phx_ref']\n\n          delete presence['phx_ref']\n          delete presence['phx_ref_prev']\n\n          return presence\n        }) as Presence[]\n      } else {\n        newState[key] = presences\n      }\n\n      return newState\n    }, {} as PresenceState)\n  }\n\n  private static cloneDeep(obj: object) {\n    return JSON.parse(JSON.stringify(obj))\n  }\n\n  onJoin(callback: PresenceOnJoinCallback): void {\n    this.caller.onJoin = callback\n  }\n\n  onLeave(callback: PresenceOnLeaveCallback): void {\n    this.caller.onLeave = callback\n  }\n\n  onSync(callback: () => void): void {\n    this.caller.onSync = callback\n  }\n\n  list<T = any>(by?: PresenceChooser<T>): T[] {\n    return RealtimePresence.list<T>(this.state, by)\n  }\n\n  private inPendingSyncState(): boolean {\n    return !this.joinRef || this.joinRef !== this.channel.joinRef()\n  }\n}\n"]},"metadata":{},"sourceType":"module"}